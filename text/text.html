<html>

<head>
<title>メモ帳を作ろう</title>
<meta http-equiv="Content-Type" content="text/html;CHARSET=utf-8">
<meta name="GENERATOR" content="Microsoft FrontPage 4.0">
<meta name="ProgId" content="FrontPage.Editor.Document">
<link rel="stylesheet" href="../tool/style.css" type="Text/css" media="screen">
</head>

<body bgcolor="#ffffff" text="#666666"><DIV ALIGN=CENTER><!--#geoguide--></DIV>

<div id="title">
  <h2 align="left"><font color="#008000">making of text editor -メモ帳を作ろう-</font></h2>
</div>
<blockquote>
  <p>　ここでは，Windowsでいうメモ帳に相当するテキストエディタを作ってみたいと思います．MFCやWindowsプログラミングの知識がなくても，ソフトウェアを製作できる配慮をしていくつもり（C言語は知っていないと大変ですが・・・）なので，安心してついてきてくださいね．実際にソフトウェアを作成しながら，キーワードや重要な操作を書いていきます．そのあたりはぜひ習得してください．</p>
  <p><u>このセクションは，MFCプログラミング初心者向けですので，より分かりやすくするために文書を色分けしています．</u></p>
  <p align="center">◇</p>
  <div id="keyword">
    VisualC++でプログラミングを進めていく上で，是非知っておくと便利なキーワードとその説明です．
  </div>
  <div id="method">
    具体的な操作手順が書かれています．
  </div>
  <div id="point">
    プログラムに関するちょっとしたことが書かれています．
  </div>
  <div id="source">
    ソースファイル
  </div>
</blockquote>
<h4>■　AppWizardを使ってプロジェクトを作成する．</h4>
<blockquote>
  <p>　AppWizardは，その名の通り，Windowsプログラミングのためのプロジェクトを自動生成してくれる「魔法使い」のことです．これを利用して簡単にプロジェクトを作成することができます．</p>
  <div id="keyword">
    <b><u>VisualC++によるアプリケーション開発をする時に使われる概念</u></b>
    <p><b><font color="#FF0000">ワークスペース(WorkSpace)</font></b><br>
    　１つあるいは複数のプロジェクトを総括するもの．現在は１つのワークスペースに１つのプロジェクトというのが<br>
    管理の面で主流になっている．<br>
    <font color="#008000" size="2">※　机の引出しのようなもの．引出しの中には，１つあるいは複数の授業科目のルーズリーフ帳（プロジェクト）が入っている．</font><br>
    <b><font color="#FF0000">プロジェクト(Project)</font></b><br>
    　１つのアプリケーションを作成するための土台．<br>
    <font color="#008000" size="2">※　１つの科目のルーズリーフ帳のようなもの．この中に挟まっているルーズリーフに勉強したこと（プログラム）が書かれている．</font><br>
    <b><font color="#FF0000">プログラム，ソース(Program,Source)</font></b><br>
    　プログラムのソースコード．プロジェクト内に入っているソースのみがアプリケーション作成に適用される．<br>
    <font color="#008000" size="2">※　ルーズリーフに書いた内容に相当</font></p>
    <p><b><u>一般的なアプリケーション形式の種類</u></b></p>
    <p><b><font color="#FF0000">SDI(Single Document Interface)</font></b><br>
    　Windows付属のメモ帳のように，メインウィンドウのみで，サブウィンドウが存在しないウィンドウ形式．<br>
    <b><font color="#FF0000">MDI(Multi Document Interface)</font></b><br>
    　メインウィンドウがあり，その中にサブウィンドウが存在するウィンドウ形式．VisualC++もそのひとつ．<br>
    機能は充実するが，プログラミングは結構大変になることが多い．<br>
    <b><font color="#FF0000">DLG(Dialog)</font></b><br>
    　メニューが存在せず，ボタン等のGUIを多用するウィンドウ形式．ファイルを開くときに出てくる，<br>
    ファイル選択ウィンドウがこの形式の代表．
  </div>
  <p>では実際の手順に入りましょう．</p>
  <div id="method">
    <ol>
      <li>[ファイル]--[新規作成]　を選び、プロジェクトのタブをクリック</li>
      <li><b>MFC AppWizard(exe)</b>を選びプロジェクト名を記述<br>
        <font color="#008000" size="2">※　ここではNotepadというプロジェクト名でソフトを作成する．<br>
        ※　ここで「新しくワークスペースを作成する」にチェックが入れておく．</font></li>
      <li>[Step1] で<b>MDI</b>を選択．<br>
        <font color="#008000" size="2">※　複数ファイルを操作できるアプリケーションになる．</font></li>
      <li>[Step5]までは「次へ」を押していきます．</li>
      <li>[Step6]にてCNotepadViewクラスをハイライトすると，「基本クラス」コンボボックスが選択できる．<br>
        ここを<b>CEditView</b>に変更する．</li>
      <li>最後に終了ボタンを押す．<br>
        <font size="2" color="#008000">※ 
        このアプリケーションに必要なファイルの雛形が作られる．</font></li>
    </ol>
  </div>
  <br>
  　上記の手順の中で，一番謎な部分は，おそらく手順５のところだと思います．C言語を知っている方でもC++のことをまったく知らなければ「クラス」という言葉やましては「基本クラス」なんていうものが分からないからです．ここではクラスに関する詳しい説明はしませんが，簡単に言うと，”<b>構造体と構造体のデータを変更する関数がセットになったもの</b>”を想像しておいてください．
  <p align="center">◇</p>
  <p>　MFCアプリケーションでは，「内部データ」と「表示」のコーディングを分離させることで，プログラムの複雑化を防ぐという考え方があります．これを「Document-View構造」というのですが，手順５では，そのView（表示；ビュー）の基本をCEditViewというものに指定したということになります．アプリケーションにはいろんな表示方法があります．例えば，<br>
  　<b>「テキストエディタ」</b>のように単色で飾りのないテキストを表示するもの<br>
  　<b>「ワープロ」</b>のように複数のいろや写真などを使って飾ったテキストを表示するもの<b><br>
  </b>　<b>「ブラウザ」</b>のようにHTML言語で記述されたもの<br>
  　<b>「お絵かき帳」</b>のようにビットマップを表示するもの<br>
  　<b>「エクスプローラ」</b>のように，リストやツリーを表示するもの<br>
  などです．いちいちこれらを実現しようと思うと非常に大変なことになります．だいたい私のようにデザインセンスがなければ(^-^;)かっこ悪いものになりそうですし．そこでMFCではあらかじめよく使いそうなものをクラスという形で提供しています．今回使用するCEditViewクラスは，表示部分に関して，テキストエディタとして便利なデータや関数を提供してくれます．今回はその恩恵を授かろうということです．ちなみに・・・表示に関する基本クラスの一例を載せておきます．</p>
  <dl>
    <dt><b>CView</b></dt>
    <dd>すべてのビューの基本．（ビットマップを表示していることになります）</dd>
    <dt><b>CEditView</b></dt>
    <dd>エディットボックスに基づいたビュー．テキストの入力と編集ができます．</dd>
    <dt><b>CRichEditView</b></dt>
    <dd>CEditViewと似ていますが，書式化された（例えばフォント種類，フォントサイズ，カラー）テキストや画像などのオブジェクトの貼り付けなどが可能なビュー．</dd>
    <dt><b>CListView</b></dt>
    <dd>フォルダ内やエクスプローラの右側部分のような表示をするビュー．</dd>
    <dt><b>CTreeView</b></dt>
    <dd>エクスプローラの左側部分や，フォルダ選択ダイアログのように，ファイル構造などの木構造を表示するビュー</dd>
    <dt><b>CHtmlView</b></dt>
    <dd>Webブラウザビュー．VisualC++6.0から適用できます．</dd>
  </dl>
  <div id="point">
    　AppWizardの”[Step6]--AppWizardで作成される新規アプリケ−ションクラス--”で基本クラスを変更しなくても，後で基本クラスの変更は可能です．作成したプロジェクトがNotePadならば，NotePad.cppに含まれる<b>CNotePadApp::InitInstance</b>という部分で変更が可能です．ただしこれにはドキュメントテンプレートの概念はもちろん，Document-View構造をよく理解しないとなかなか出来ないので，最初に変更しておくのです．
  </div>
</blockquote>
<h4>■　プロジェクトの実行</h4>
<blockquote>
  <p>　アプリケーションを作るためには，実行をしなくてはいけません．VisualC++における実行までの操作は，大きく分けて3種類あります．</p>
  <div id="keyword">
    <b><font color="#FF0000">コンパイル(Compile)</font></b><br>
    　現在アクティブなプロジェクト内に登録されている，*.cおよび*.cppファイルのシンタックス（文法）チェックを行い，*.objという（オブジェクト）ファイルを生成します．簡単にいうと，0と1で記述されたファイルに変換することを指します．<br>
    <b><font color="#FF0000">ビルド(Build)</font></b><br>
    　プロジェクト内のすべてのファイルをコンパイルし，dllなどのライブラリをリンクします．コンパイラとリンカの仕事を一般にやってくれます．<br>
    <b><font color="#FF0000">実行(execute)</font></b><br>
    　ビルドと実行形式のファイルの実行まですべてを行います．
  </div>
  <p>　「プロジェクトの実行」をする際には，メニューから<b>「ビルド」-「実行」</b>を選択すればOKです．実行できれば，簡単なメモ帳が生成されるでしょう．テキストファイルを開いてみるなりして動作を確認してみましょう．</p>
</blockquote>
<h4>■　アプリケーション外観のカスタマイズ（リソースの編集）</h4>
<blockquote>
  <p>　前項にて，プロジェクトの実行ができましたか？そしてメモ帳のように編集することが可能なアプリケーションができているでしょうか？私達は実際コーディングをしたわけでもないのにある程度のものが出来上がってしまいましたが，これは基本クラスとしてCEditViewに設定した賜物です．しかしちょっと操作すると，いろんなところが使いにくいのです...．</p>
  <p>　私は，プログラムの良し悪しには３つあると考えています．</p>
  <ul>
    <li>正しいコーディングがなされていること．</li>
    <li>使われているアルゴリズムがそのアプリケーションに適していること．</li>
    <li>優れたユーザインターフェースをもつこと．</li>
  </ul>
  <p>　1つ目は当たり前なんですが，一番みんなが苦しむところです．一見正しそうなコーディング（もちろんコンパイルが通るので文法的には間違っていない）でも，実行すると強制終了してしまったり，動作がおかしかったりすること，つまるところ<b>バグ</b>ですね．2つ目はアルゴリズムとアプリケーションの相性．いくらすばらしいアルゴリズムを使っても，使い方によっては，ほとんど意味をなさないことなんてあります．まぁこれらは経験で学ぶとして，Windows 
  Programmingで重要になるのは，プログラムという<b>「機械」と「人間」の間の仲介役となるユーザインターフェース</b>なのです．</p>
  <p>　ではユーザインターフェースをある程度改良してみましょう．このユーザインターフェースの改良に欠かせないのが，リソースと呼ばれるものです．</p>
  <div id="keyword">
    <b><font color="#FF0000">リソース(Resource)</font></b><br>
    　メニュー，アイコン、ビットマップなどのGUIを支援する共通のデータパーツ資源で，プログラムとは別に作成され，実行時にバインド（結びつけ)される。リソースのメリットは，
    <ul>
      <li>複雑なWindowsプログラムと複GUIパーツの描画・操作処理などが絡んで、<br>
        もっとプログラムが余計に複雑になるのを防ぐ事ができる．</li>
      <li>既成のプログラムのリソースを変更することで，外観を簡単に変更できる．</li>
    </ul>
    <p>などがある．</p>
  </div>
  <p>以下に示すものは，MFCで使用される主なリソースの種類です．</p>
  <dl>
    <dt><b>アクセラレータ(Accelerator)</b>
    <dd>ショートカットキーを設定します．
    <dt><b>ビットマップ(Bitmap)</b>
    <dd>ビットマップを作成・設定します．
    <dt><b>カーソル(Cursul)</b>
    <dd>特別なカーソルを設定します．
    <dt><b>ダイアログ(Dialog)</b>
    <dd>ダイアログウィンドウを作成・設定します．
    <dt><b>アイコン(Icon)</b>
    <dd>プログラム中のアイコンを作成・設定します．
    <dt><b>メニュー(Menu)</b>
    <dd>メニューを作成・設定をします．
    <dt><b>ストリングテーブル(String Table)</b>
    <dd>アプリケーションで使用する固有の文字列（ウィンドウタイトル・エラーメッセージなど）を設定します．
    <dt><b>ツールバー(Tool Bar)</b>
    <dd>ツールバーを作成・設定します
  </dl>
  <p>ここでは，以下の点のリソースを変更していきたいと思います．</p>
  <h4>◇　開くファイルをテキストに指定する＜ストリングテーブルの改良＞</h4>
  <blockquote>
    <div id="keyword">
      <font color="#FF0000"><b>ストリングテーブル(String Table)</b></font><br>
      　ツールバー，ボタン，メニューなどの上にマウスカーソルがあると、小さな説明(ツールチップ)が表示されたり，ウィンドウ下のステータスバーに文字列が表示されることに気づく．これは，そのリソースのIDにそれぞれ割り当てられているプロンプトが表示されているためであるが，そのプロンプトをまとめたものをストリングテーブルという．<br>
      <br>
      　ストリングテーブルの中でも特別なものが幾つかある．
      <dl>
        <dt><b>IDR_MAINFRAME</b></dt>
        <dd>タイトル名や開かれるファイルに関する指定がなされる重要な項目</dd>
        <dt><b>IDR_******TYPE</b></dt>
        <dd>MDI子ウィンドウ用の重要な(SDIでIDR_MAINFRAMEに対してするような)指定がなされる項目</dd>
        <dt><b>AFX_IDS_IDLEMESSAGE</b></dt>
        <dd>何もされていない時に，ステータスバーに表示される項目（レディなど）</dd>
        <dt><b>AFX_IDS_APP_TITEL</b></dt>
        <dd>アプリケーションのタイトル（厳密に言うとプロジェクト名？）</dd>
      </dl>
    </div>
    <p>　今回は，「開くファイルをテキストファイルに指定する」のが目的なのですから，ストリングテーブルのIDR_MAINFRAMEを編集すればいいのですねが，実際はIDR_******_TYPEを編集していきます．それはこのアプリケーションがMDIタイプであるためです．SDIであったらIDR_MAINFRAMEの方でOKです．では作業を進めていきます．</p>
    <div id="method">
      <ol>
        <li>ワークスペースウィンドウ(通常左端のドッキングウィンドウ)のリソースタブをクリック．</li>
        <li>String Tableフォルダのstring tableをダブルクリック<br>
          <font color="#008000" size="2">※ ID/値/キャプション　などが書かれた表(ストリングテーブル)が表示される．</font></li>
        <li>IDR_NOTEPATYPEと書かれているものをダブルクリック．<br>
          <font color="#008000" size="2">※ String プロパティが開く．</font></li>
        <li>キャプションを以下のように変更します．<br>
          　<font color="#FF0000"><b>NotePad</b>\n<b>新規</b>\n\n<b>TextFile(*.txt)</b>\n<b>.txt</b>\n\n</font></li>
        <li>プロジェクトを実行し，ファイルを開いてみる．<br>
          <font size="2" color="#00800">※ figure1のように反映されるはずである．</font></li>
      </ol>
    </div>
    <p>　</p>
    <p><b>figure.1 ストリングテーブルの変更</b><br>
    <img border="0" src="fig1.jpg" width="584" height="324"></p>
    <p>　先ほど，IDR_NOTEPATYPEのキャプションを以下のように書き換えてみました．なにやら見慣れない文字列のような気がしますが，ちゃんとした意味があります．</p>
    <blockquote>
      <p><b><font color="#FF0000">NotePad</font></b>\n<font color="#0000FF"><b>新規</b></font>\n\n<font color="#008000"><b>TextFile(*.txt)</b></font>\n<font color="#000000"><b>.txt</b></font>\n\n</p>
    </blockquote>
    <b><font color="#FF0000">NotePad</font> <font color="#FF0000">(赤字)</font></b>：ウィンドウ上部のタイトルバーに示されるウィンドウのタイトル名．<br>
    <font color="#0000FF"><b>新規</b> (青文字)</font>：ディフォルトで表示されるドキュメント名，省略するとUntitledになる．<br>
    <font color="#008000"><b>TextFile(*.txt)</b> (緑字)</font>：「ファイルの種類」コンボボックスに表示されるもの．<br>
    <font color="#000000"><b>.txt</b> (黒字)</font>：開く・保存されるときにダイアログにリストアップされるファイルの拡張子．
    <p>　分かりやすくするためにfigure1にも色別に示しています．また，&quot;\n&quot;がいっぱいあるなぁと思うかもしれません．これは，IDR_MAINFRAMEやIDR_NOTEPATYPEでは７つのプロンプトを設定する必要があるため，その区切り記号として&quot;\n&quot;が使われているからです．設定しない場合は単に省略するだけでOKです．</p>
  </blockquote>
</blockquote>
<h4>■ （コラム）　MFC (Microsoft Foundation Class) と 
オブジェクト指向(Object Oriented)</h4>
<blockquote>
  <p>　さて，そろそろ疲れてきたころだと思うので，少しコラムを１つ．コラムといってもこれから「MFC」というライブラリを使うための重要な概念についてなのでしっかり読んでいただけたら幸いです．</p>
  <p>　ハンバーガを食べたい時，皆さんはハンバーガショップに行くと思います．そこで，ハンバーガを注文すると無事食べることができます．ここで変な質問です．<b>「あなたはなぜハンバーガを食べることができたのですか？」</b>　この質問に対してこう答えるしかないですよね．「ハンバーガ屋に注文すれば，食べることができるのを知っていたから」，と．ここで重要なのは，ハンバーガを食べる側は，ハンバーガの材料は何か？調理法は？などの細かい操作を知る必要がないということです．</p>
  <p>　これは実世界の思考と通じる所がありますよね．例えば，配属されてきた新入社員たちに，先輩社員は「自己紹介してよ」といえば，新入社員はそれぞれの方法，それぞれの手段をつかって自己紹介するでしょう．先輩社員は，細かい指示をせず自己紹介をさせることができるのです．このように物や人（オブジェクト）が行う細かい動作を気にすることなく，作業を実現する物主体の考え方を，<b>「オブジェクト指向」</b>といい，プログラムでもこの考えを取り入れることが盛んになってきています．オブジェクト指向についての細かい話は他の文献に譲りますが，大体こんなものだということだけ頭に入れておいてください．</p>
  <p align="center">◇</p>
  <p>　さていま私達が取り組んでいるMFCに話は変わりますが，MFCとは，<b>M</b>icrosoft 
  <b>F</b>oundation <b>C</b>lass libraryと呼ばれる，C++言語によるオブジェクト指向がサポートされたWindows 
  Programmingライブラリのことです．私達が取り組んでいるメモ帳も，たいしたプログラミングもせずにある程度のメモ帳が出来上がっていますよね．それはMFCが提供する<b>CEditView</b>というものが，メモ帳に必要な細かい操作を行ってくれているので，私達は細かい操作を気にしないでプログラミングしているわけです．だから私達が習得することは，如何にしてCEditViewの恩恵を受けるか，つまりCEditViewの使い方を知るかどうか？だけを考えればよいのですね．そこで次節では，メニューコマンドの操作について学んでいきましょう．</p>
</blockquote>
<h4>■　メニューコマンドの操作</h4>
<blockquote>
  <p>さて，実際にCEditViewのクラスライブラリを使って，メニューコマンドから検索や置換などができるようにしてみましょう．文字列の操作なんてできないよ・・・と思っている人もいるかもしれませんが，ここではCEditViewのそれぞれの機能を呼び出してあげれば簡単に実現できます．</p>
  <div id="method">
    <h5>◇　削除(<u>D</u>)というメニューを追加する．</h5>
    <ol>
      <li>ワークスペースのリソースタブをクリックし，メニューフォルダのIDR_NOTEPATYPEをダブルクリック.</li>
      <li>メニューの「編集」をクリックし，メニュー内で項目が無いところをハイライト，右クリック，プロパティ(figure.2)．</li>
      <li>プロパティダイアログに以下の内容を記述(figure.3)．<br>
        キャプション　<font color="#FF0000">削除(&amp;D)</font><br>
        ID：<font color="#FF0000">ID_EDIT_CLEAR<br>
        </font><font color="#008000" size="2">※ 
        記述すると，プロンプトの欄に自動的に何か文字列が書き込まれますが，これはID_EDIT_CLEARというメッセージIDが，CEditViewで定義されているためです．</font></li>
      <li>ダイアログを閉じ，ビルドすると削除のメニューが追加され，エディタ内の文字を削除することが可能．</li>
    </ol>
  </div>
  <p><b>figure.2 位置の選択</b><br>
  <img border="0" src="fig2.gif" width="260" height="165"></p>
  <p><b>figure.3 プロパティの変更</b><br>
  <img border="0" src="fig3.gif" width="466" height="153"></p>
  <p align="center">◇</p>
  <div id="method">
    <h5>◇　水平線(セパレータ)を入れる</h5>
    <ol>
      <li>削除のメニュー追加と同様に１と２を行う．</li>
      <li>現れたダイアログで<b>セパレータ</b>にチェックを入れる．</li>
    </ol>
  </div>
  <p>　このような感じでメニューをどんどん追加していけばいいのです．ただこれはこれらのIDがすでにどこかで定義されているからこのように簡単な操作でできるということを覚えておいてください．もう少し具体的に言えば，例えば削除メニューを押すと，OSにID_EDIT_CLEARというメッセージが流れます．それをエディタがキャッチし，CEditViewでID_EDIT_CLEARに割り当てられている操作を行っているだけです．</p>
  <p>　残りの操作は自力でやってみてください．そのためには操作に対応したIDが分からないとダメですね．簡単なやつだけ表にまとめておきます．</p>
  <table border="4" cellspacing="1" cellpadding="0">
    <tr>
      <th>メニュ-</th>
      <th>追加項目</th>
      <th>ID</th>
      <th>メニュ-</th>
      <th>追加項目</th>
      <th>ID</th>
    </tr>
    <tr>
      <td>ファイル</td>
      <td>新規作成</td>
      <td>ID_FILE_NEW</td>
      <td>編集</td>
      <td>コピー</td>
      <td>ID_EDIT_COPY</td>
    </tr>
    <tr>
      <td>　</td>
      <td>開く</td>
      <td>ID_FILE_OPEN</td>
      <td>　</td>
      <td>貼りつけ</td>
      <td>ID_EDIT_PASTE</td>
    </tr>
    <tr>
      <td>　</td>
      <td>上書き保存</td>
      <td>ID_FILE_SAVE</td>
      <td>　</td>
      <td>削除</td>
      <td>ID_EDIT_CLEAR</td>
    </tr>
    <tr>
      <td>　</td>
      <td>名前をつけて保存</td>
      <td>ID_FILE_SAVE_AS</td>
      <td>　</td>
      <td>文字列の検索</td>
      <td>ID_EDIT_FIND</td>
    </tr>
    <tr>
      <td>　</td>
      <td>閉じる</td>
      <td>ID_FILE_CLOSE</td>
      <td>　</td>
      <td>文字列の置換</td>
      <td>ID_EDIT_REPLACE</td>
    </tr>
    <tr>
      <td>　</td>
      <td>プリンタの設定</td>
      <td>ID_FILE_PRINT_SETUP</td>
      <td>　</td>
      <td>全て選択</td>
      <td>ID_EDIT_SELECT_ALL</td>
    </tr>
    <tr>
      <td>　</td>
      <td>印刷</td>
      <td>ID_FILE_PRINT</td>
      <td>ウィンドウ</td>
      <td>新しいウィンドウを開く</td>
      <td>ID_WINDOW_NEW</td>
    </tr>
    <tr>
      <td>　</td>
      <td>アプリケーションの終了</td>
      <td>ID_APP_EXIT</td>
      <td>　</td>
      <td>重ねて表示</td>
      <td>ID_WINDOW_CASCADE</td>
    </tr>
    <tr>
      <td>編集</td>
      <td>元に戻す</td>
      <td>ID_EDIT_UNDO</td>
      <td>　</td>
      <td>並べて表示</td>
      <td>ID_WINDOW_HORZ</td>
    </tr>
    <tr>
      <td>　</td>
      <td>切り取り</td>
      <td>ID_EDIT_CUT</td>
      <td>ヘルプ</td>
      <td>バージョン情報</td>
      <td>ID_APP_ABOUT</td>
    </tr>
  </table>
  <p>こんな風にできたらいいと思います．頑張ってみてください．</p>
  <p><img border="0" src="fig4.gif" width="348" height="223"></p>
</blockquote>
<h4>■　フォントを変更できるようにしよう</h4>
<blockquote>
  <p>　Windowsに付いてくるメモ帳も，フォントを変更することができます．私達もフォントが変更できるように頑張ってみましょう．まず，フォントの変更に関する仕様は以下の通りとします．</p>
  <div id="point">
    <ol>
      <li>ユーザがメニュー内の[フォントの変更]をクリック．</li>
      <li>フォント選択ダイアログが開く．</li>
      <li>フォントをユーザが指定する．</li>
      <li>指定された通りにフォントに変更する．</li>
    </ol>
  </div>
  <p>　このようにプログラムを書く前にある程度の仕様というかストーリー？を考えておくことは，プログラミングでは重要です．ではまずはじめに，「フォントの変更」メニューを追加してみましょう．といっても別に目新しいことではありません．先ほど削除メニューを追加したこととほとんど同じです・</p>
  <div id="method">
    <ol>
      <li>ワークスペースのリソースタブをクリックし，メニューフォルダのIDR_NOTEPATYPEをダブルクリック.</li>
      <li>メニューの「表示」をクリックし，メニュー内で項目が無いところをハイライト，右クリック，プロパティ．</li>
      <li>プロパティダイアログに以下の内容を記述．<br>
        キャプション　<font color="#FF0000">フォントの変更(&amp;F)</font><br>
        ID：<font color="#FF0000">ID_VIEW_FONT<br>
        </font>プロンプト：<font color="#FF0000">使用するフォントを変更する\nフォントの変更</font></li>
      <li>ダイアログを閉じる．</li>
    </ol>
  </div>
  <p>こうするとメニューの「表示」に「フォントの変更」という項目が追加されます．先ほど「削除」メニューを追加した時と違うことはメニューのIDが適当でいいということです．つまりこのIDは自分で決めることが可能です．でもできるだけわかりやすいIDにしておくことも重要です．ここでIDとWindowsについて少しお話をしておきます．</p>
  <div id="point">
    <b>Windowsとメッセージ</b>
    <p>　Windowsはメッセージと呼ばれるものを使って動いています．例えばウィンドウの右上の×ボタン（システムボタン）が押されると，ウィンドウは消えることになっていますが，これは「ウィンドウ消去」というメッセージがOS(Windows)から送られてくるのをアプリケーションが取得し，既存の動作をさせているのです．このようにWindowsプログラミングはメッセージのやり取りだと思ってもいいかもしれません．
  </div>
  <p>　さっきからIDと呼ばれているものは，実はメッセージに相当します．つまり「フォントの変更」を押すとOSから，ID_VIEW_FONTというメッセージがやってくるので，それを捕まえてフォントの変更処理をすることで先ほど仕様として決めたことが実現できるのです．となるとメッセージを捕まえる機構が必要ですよね〜．それを実現するのがClassWizardです．</p>
  <div id="method">
    <ol>
      <li>メニュー「表示」-「ClassWizard」を開き，メッセージマップタブをクリック．</li>
      <li>以下のように選択・ハイライトする(figure5)<br>
        プロジェクト：NotePad<br>
        クラス名：CNotePadView<br>
        オブジェクトID：ID_VIEW_FONT<br>
        メッセージ：COMMAND</li>
      <li>関数の追加ボタンを押し，関数名をOnViewFont（ディフォルト）に設定しOKを押す．</li>
      <li>最後にコード編集ボタンを押す．<br>
        <font size="2" color="#008000">※　これを押さずに下のOKボタンの押してClassWizardを閉じた後，ワークスペースのクラスビューから，CNotePadViewを参照することも可能．</font></li>
    </ol>
  </div>
  <p><b>figure.5 ClassWizardによる設定</b><br>
  <img border="0" src="fig5.jpg" width="649" height="376"></p>
  <p>　いったい何をしたのだろう？と思う人は，<b>ID_VIEW_FONTが押された時にCNotePadView内の関数OnViewFontが実行されるようにマッピングした</b>と考えれば多少は分かるかも知れません．だからClassWizardのこの画面は，メッセージマップというのです．したがってフォントの変更のコーディングはOnViewFontに書けばよいということになります．ちなみにフォントの変更は外観の変更に過ぎません．したがって関数は外観を扱うViewに追加するのがベストです．</p>
  <p align="center">◇</p>
  <p>　いま，NotePadView.cppが開かれていると思います（そうでなかったら開いておいてくださいね）．多分以下のように書かれているので，</p>
  <div id="source">
    <pre><font color="#008040">/////////////////////////////////////////////////////////////////////////////</font>
<font color="#008040">// CNotePadView クラスのメッセージ ハンドラ</font>

<font color="#0000ff">void</font> CNotePadView::OnViewFont() 
{
	<font color="#008040">// TODO: この位置にコマンド ハンドラ用のコードを追加してください</font>
	
}</pre>
  </div>
  <p>　これを以下のように変更してみましょう．　</p>
  <div id="source">
    <pre><font color="#0000ff">void</font> CNotePadView::OnViewFont() 
{
	AfxMessageBox(&quot;VisualC++&quot;);		<font color="#008040">// Open Message Box</font>
}</pre>
  </div>
  <p>　では実行してみましょう．フォントの変更をクリックすると，VisualC++と書かれた小さなウィンドウ（メッセージボックス）が表示されたら成功です．これでメニューと関数がしっかり対応付けされているということがわかりますね．AfxMessageBox関数は，MFCを使用している場合ならどこでも使用することが可能なので，C言語のprintf関数のようにデバックにも有効だと思います．</p>
  <p align="center">◇</p>
  <p>　それではフォントの変更プログラムを書いていきましょう．まずビュークラス(CNotePadView)にフォントを扱う変数を追加しておきます．このような変数を，C++ではメンバ変数と呼びます．ちなみに先ほど追加したOnViewFontはメンバ関数になります．</p>
  <div id="method">
    <ol>
      <li>ワークスペースのクラスタブをクリックし，CNotePadViewを右クリックし，メンバ変数の追加をクリック<br>
        <font color="#008000" size="2">※　ダイアログが開かれます．</font></li>
      <li>ダイアログに以下の値を設定してOKを押す．<br>
        変数のタイプ：CFont<br>
        変数名：m_Font<br>
        アクセス制御：private</li>
    </ol>
  </div>
  <p>　追加したものは，フォントを操作するためにMFCで用意されているCFontクラスの変数です．うまく追加できると，クラスビューがこんな感じに表示されます．</p>
  <p><b>figure.6 メンバ変数の追加</b><br>
  <img border="0" src="fig6.jpg" width="233" height="226">　</p>
  <p>　実際には，NotePad.hファイルにこのように宣言されます．逆にいえばメンバの追加は，直接コーディングで行うことができるということですね．</p>
  <div id="source">
    <pre><font color="#008040">// 生成されたメッセージ マップ関数</font>
<font color="#0000ff">protected</font>:
	<font color="#008040">//{{AFX_MSG(CNotePadView)</font>
	afx_msg <font color="#0000ff">void</font> OnViewFont();
	<font color="#008040">//}}AFX_MSG</font>
	DECLARE_MESSAGE_MAP()
<font color="#0000ff">private</font>:
	CFont m_Font;
};</pre>
  </div>
  <p>　ちなみに上のコードを見てみると，OnViewFontの定義もされていますね．これはClassWizardのメッセージマップで作られために，//{{AFX_MSG(CNotePadView) 
  なんていうやつで囲まれていますが，メンバ関数のひとつです．先ほどから気になっている人がいるかもしれませんが，アクセス制御(privateとかpublicとか)とはなんでしょう？それは実はオブジェクト指向に秘密があります．</p>
  <div id="point">
    <h5>アクセス制御</h5>
    　オブジェクト指向では，オブジェクトの「状態」と「状態を変化させる手段」を持つことになっています．例えば，人間というオブジェクトの状態の１つに「体重」があります．そして体重を変化させる手段として「食事」「ダイエット」などがあります．ここで重要なことは，一般的に「状態」は「状態を変化させる手段」以外では変化させることができないのです．だから「運動しない」という手段では当然「体重」は減りません．こうすることで，ある種の情報を外部から見えなくすることができます．これを情報隠蔽といい，オブジェクト指向の重要概念の１つです．
    <p>　しかし，これをプログラムで実現しようとする時，すべて外部から見えなくなるのも不便です．そこで３種類のアクセス制御を書けることができます．</p>
    <p><b>private</b>　クラス内部からしかみることができない．<br>
    <b>protected</b>　クラス内部からしか見ることができないが例外もある（説明は省略）<br>
    <b>public</b>　クラス外部からも参照することができる．</p>
    <p>　C++では，この「状態」に当たるものをメンバ変数，「手段」に当たるものをメンバ関数と呼びます．大抵のメンバ関数はpublicにされます．そうしないとクラス外部からはまったくアクセスができなくなってしまうからです．
  </div>
  <p align="center">◇</p>
  <p>では，フォント変更に関する準備が整いましたのでコーディングしていきましょう．</p>
  <div id="source">
    <pre><font color="#0000ff">void</font> CNotePadView::OnViewFont() 
{
	LOGFONT		lf;	<font color="#008040">// LOGFONT構造体の宣言</font>
	m_Font.GetLogFont(&amp;lf);	<font color="#008040">// 現在のフォント情報を取得</font>

	<font color="#008040">// コモンフォントダイアログの作成</font>
	CFontDialog	dlg(&amp;lf, CF_SCREENFONTS|CF_INITTOLOGFONTSTRUCT);

	<font color="#008040">// ダイアログを開く</font>
	<font color="#0000ff">if</font> (dlg.DoModal() == IDOK)
	{
		m_Font.DeleteObject();
		<font color="#0000ff">if</font>(m_Font.CreateFontIndirect(&amp;lf))
			SetFont(&amp;m_Font);
	}
}</pre>
  </div>
  <p>　はじめてC++のコーディングをする人は，へんなコーディングだなぁと思うかもしれません．クラスの変数の後ろに，&quot;<b><font size="3">.</font></b>&quot;を付けて記述していますね．この&quot;.&quot;をつけることで，そのクラス変数のメンバ関数を呼び出すことができるのです．つまり人間というクラスがあるとして，メンバ関数に自己紹介というものがあったら，以下のようにすれば自己紹介してくれます．</p>
  <div id="source">
    <pre>人間	日本太郎；
日本太郎.自己紹介();</pre>
  </div>
  <p>では，コーディングの説明をしていきます．</p>
  <p><b>LOGFONT&nbsp; lf;</b><br>
  &nbsp;　<u>フォントの情報を格納するLOGFONT構造体変数lfの定義</u>です。LOGFONT型は、フォントの大きさ・種類・高さ・角度・幅・色などの情報を格納できる変数です。　CFontクラス変数は，あくまでフォントを操作するための変数なので，フォントを扱う時には，CFont変数にLOGFONT構造体変数をセットして使います．</p>
  <p><b>m_Font.GetLogFont(&amp;lf);</b><br>
  　現在表示に使用されているフォントの情報を，CFont型変数m_Fontを使ってLOGFONT変数lfに書込みます．</p>
  <p><b>CFontDialog&nbsp;&nbsp; dlg(&amp;lf, 
  CF_SCREENFONTS|CF_INITTOLOGFONTSTRUCT);</b><br>
  　フォントを設定するコモンダイアログ(共通ダイアログ)を開きます．このとき設定した内容はLOGFONT構造体lfに格納されるように引数を指定しておきます．</p>
  <p><b>if (dlg.DoModal(&nbsp;) == IDOK) {<br>
  　</b>フォントコモンダイアログを開き，OKボタンが押された時のみif構造の中を実行します．</p>
  <p><b>m_Font.DeleteObject(&nbsp;);</b><br>
  　現在設定されているフォントを削除します．この変数が消えてしまうわけではなく，メモリーに残された現在のフォント情報を消すということです．</p>
  <p><b>if(m_Font.CreateFontIndirect(&amp;lf))</b><br>
  　LOGFONT構造体を使って，新しいフォントを作成します．成功したらif構造の中を実行します．</p>
  <p><b>SetFont(&amp;m_Font);</b><br>
  　先ほど作成したフォントm_Fontを現在のフォントとしてビューにセットし，プログラムで使用するフォントとして反映します．</p>
  <p>どんなことをしているか分からない場合は，以下の図を見てもらえれば多少分かると思います．</p>
  <p><b>figure.7 フォントの変更の仕組み</b><br>
  <img border="0" src="fig8.jpg" width="467" height="367"></p>
  <p align="center">◇</p>
  <p>早速実行してみましょう．うまくフォントが変更できたでしょうか？残念ながら「フォントの変更」を押すと，</p>
  <p><b>figure.8 エラー発生</b><br>
  <img border="0" src="fig7.jpg" width="465" height="202"></p>
  <p>　というエラーが出てきてプログラムは強制終了になってしまいます．これはASSERTといってソースファイルのシンタックス（文法）には問題はないが，おかしな動作をしている時に出るエラーです．もちろん自分でASSERTで強制終了させるプログラムを書くこともできますが．<br>
  　まぁ結果的にはプログラムが間違っているわけなので修正が必要なのですが，今回は特別に？どこが間違っているかを説明してしまいましょう（実際は自分がなんとかして調べるのです）</p>
  <p>　ソース２行目の<b>m_Font.GetLogFont(&amp;lf);</b>で現在のCFontクラスからフォント情報を得るということになっていますが，現在のCFontクラスとは何のことでしょうか？そもそもm_Fontはこちらが決めた変数ですから，Viewクラスと何も関係を持っていないのでフォント情報を持っていないのです．したがってフォントの変更が行われる前に，m_Fontにフォント情報を当てておかなくてはいけません．さて問題は<b>いつ</b>それをやるかです．</p>
  <p>　あれこれ悩むところですが，MFCのフレームワークは，タイミングや用途に合わせて既存の関数が実行させることができます（正しく言うと勝手に実行される）．テキストが開かれて表示される直前に実行される関数として，OnInitialUpdate() 
  というビューのメンバ関数を使ってフォント情報を与えるコーディングを書いていきます．まずはOnInitialUpdate関数が呼ばれるための手続きをしてあげます．基本的にアプリケーションが自動的に呼び出す関数を設定する時はClassWizardを使います．</p>
  <div id="method">
    <ol>
      <li>クラスウィザードを起動し，メッセージマップタブをクリックする．</li>
      <li>以下のように選択・ハイライトする<br>
        プロジェクト：NotePad<br>
        クラス名：CNotePadView<br>
        オブジェクトID：CNotePadView<br>
        メッセージ：OnInitialUpdate</li>
      <li>関数の追加ボタンを押し，編集ボタンを押す．(関数名の指定はなし)</li>
    </ol>
  </div>
  <p>するとNotePadView.cppにOnInitialUpdate()という関数が追加されます．ここで以下のようにコーディングしてみましょう．</p>
  <div id="source">
    <pre><font color="#0000ff">void</font> CNotePadView::OnInitialUpdate() 
{
	CEditView::OnInitialUpdate();

	LOGFONT   lf;
	
	<font color="#008040">// 表示フォントの初期設定</font>
	lf.lfHeight		=	18;
	lf.lfWidth		=	8;
	lf.lfEscapement		=	0;
	lf.lfOrientation		=	0;
	lf.lfWeight		=	400;
	lf.lfItalic		=	<font color="#0000ff">false</font>;
	lf.lfUnderline		=	<font color="#0000ff">false</font>;
	lf.lfStrikeOut		=	<font color="#0000ff">false</font>;
	lf.lfCharSet		=	SHIFTJIS_CHARSET;
	lf.lfOutPrecision		=	OUT_DEFAULT_PRECIS;
	lf.lfClipPrecision		=	OUT_DEFAULT_PRECIS;
	lf.lfQuality		=	OUT_DEFAULT_PRECIS;
	lf.lfPitchAndFamily	=	OUT_DEFAULT_PRECIS;
	strcpy( lf.lfFaceName, &quot;FixedSys&quot; );

	ASSERT(m_Font.CreateFontIndirect(&amp;lf));
	SetFont(&amp;m_Font);	
}</pre>
  </div>
  <p>ではまた解説していきます．</p>
  <p><b>CEditView::OnInitialUpdate();</b><br>
  関数を作った時にかかれていたものです．ここではくわしく説明しません．「触らぬものにたたりなし」です．</p>
  <p><b>LOGFONT&nbsp;&nbsp; lf;</b><br>
  LOGFONT構造体変数のlfです．OnViewFont関数のlfでなくて、この関数内だけのlfだということに注意してください．</p>
  <p><b>lf.〜</b><br>
  　これはフォントの設定をしています．LOGFONT構造体について調べればある程度分かると思いますが，こういうものだと認識してもかまいません．初期フォントとして，VisualC++のソースで使用されるフォントを採用しています．</p>
  <p><b>ASSERT(m_Font.CreateFontIndirect(&amp;lf));</b><br>
  　m_Font.CreateFontIndirect(&amp;lf)で上で指定したフォント情報をm_Fontに取り込みます．この関数が失敗するとフォントの設定がうまくいかなくなり，アプリケーションとして成り立たないので，この関数が失敗したらASSERTされるようにしておきます．つまり強制終了です．成功したらASSERTはされません．</p>
  <p><b>SetFont(&amp;m_Font);</b><br>
  　フォントの設定に成功しているのであとはビューとフォントを関連付けするだけです．</p>
  <p>　最後に実行してみましょう．フォントの変更が正しくできますか？テキストごとに異なるフォントが設定できましたか？いろいろチェックしてみてください(figure.9)．</p>
  <p><b>figure.9 フォントの変更に成功</b><br>
  <img border="0" src="fig9.jpg" width="441" height="415"></p>
</blockquote>
<h4>■　配布できるプログラムにしよう．</h4>
<blockquote>
  　通常VisualC++のプログラミング環境は大きく分けて，
  <ul>
    <li>Win32 Debug</li>
    <li>Win32 Release</li>
  </ul>
  <p>という２つの環境が存在します．Win32 Debug環境は，デバッグ環境が整った開発環境ですが，コードの最適化がなされていません．逆にWin32 
  Release環境は，デバッグ環境はないものの，コードの最適化がなされます．通常はWin32 
  Debug環境でプログラミングを行い，プログラムが出来上がって実用するときにRelease環境でビルドしてあげるというのが一般的です．メモ帳も出来上がったのでここでRelease環境にしてビルドしてみましょう．そうすることでアプリケーションのファイルサイズが小さくなったり，スピードが上がります．</p>
  <div id="method">
    <ol>
      <li>メニューから[ビルド]-[アクティブな構成の設定]をクリック．</li>
      <li>プロジェクトの標準構成を，Win32 Releaseに変更してOK．</li>
      <li>[ビルド]-[実行]でプロジェクトを再ビルド．</li>
    </ol>
  </div>
  <p>　またデバッグが必要になったときなどは同じようにして設定をすれば両方が使い分けられますね．ちなみに出来上がった実行形式のファイルは，プロジェクトが存在するディレクトリの中にある，Debug/Releaseのディレクトリにそれぞれ入っています．</p>
</blockquote>
<p>メモ帳を通してMFCプログラミングが，少し分かっていただけましたでしょうか？分からないことがありましたらお気軽に連絡をください．</p>
<p>[<a href="../index.html">back to index</a>]</p>
<p align="right">Copyright by Chiaki Fujimon.<br>
All Rights Reserved.</p>

</body>

</html>
